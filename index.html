<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bengt's Wish List</title>

  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Roboto&display=swap"
    rel="stylesheet"
  />

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <style>
    /* --- Styles siehe vorherige Antwort (nicht nochmal komplett hier, außer gewünscht) --- */
    /* Einfach den Style-Block aus der vorherigen Antwort komplett übernehmen */
  </style>
</head>
<body>
  <header>
    <div class="title">Bengt’s Wish List</div>
    <button class="add-button" aria-label="Add Product" id="addBtn">Add</button>
  </header>

  <main id="product-list" aria-live="polite" aria-relevant="additions removals"></main>

  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
      <button class="close-modal" aria-label="Close modal" id="closeModalBtn">&times;</button>
      <h2 id="modalTitle">Add New Product</h2>
      <label for="imgUrl">Image URL *</label>
      <input type="url" id="imgUrl" placeholder="https://example.com/image.jpg" required />
      <label for="name">Product Name *</label>
      <input type="text" id="name" placeholder="Your product name" required />
      <label for="price">Price (e.g. €79.99)</label>
      <input type="text" id="price" placeholder="€79.99" />
      <label for="priority">Priority</label>
      <select id="priority" aria-label="Product priority">
        <option value="medium" selected>Medium</option>
        <option value="high">High</option>
        <option value="low">Low</option>
      </select>
      <label for="note">Note (optional)</label>
      <textarea id="note" placeholder="Additional notes or details..."></textarea>
      <label for="link">Shop URL *</label>
      <input type="url" id="link" placeholder="https://example.com/product" required />
      <button id="saveBtn">Save Product</button>
    </div>
  </div>

  <div id="controls" role="region" aria-label="Sorting and color customization">
    <select id="sortSelect" aria-label="Sort products">
      <option value="addedDesc">Sort: Newest</option>
      <option value="addedAsc">Sort: Oldest</option>
      <option value="nameAsc">Sort: Name A-Z</option>
      <option value="nameDesc">Sort: Name Z-A</option>
      <option value="priceAsc">Sort: Price Low-High</option>
      <option value="priceDesc">Sort: Price High-Low</option>
      <option value="priorityAsc">Sort: Priority Low-High</option>
      <option value="priorityDesc">Sort: Priority High-Low</option>
    </select>
    <input
      type="color"
      id="colorPicker"
      aria-label="Choose accent color"
      title="Choose accent color"
    />
  </div>

  <div id="syncStatus" title="Syncing data">
    <i class="fas fa-sync-alt fa-spin"></i>
  </div>

  <script>
    // Firebase Config (bitte durch dein eigenes ersetzen)
    const firebaseConfig = {
      apiKey: "AIzaSyAmGhT9CjCMoICHA-B6w28_eGZqsq7dfpM",
      authDomain: "bengts-wishlist.firebaseapp.com",
      databaseURL:
        "https://bengts-wishlist-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "bengts-wishlist",
      storageBucket: "bengts-wishlist.appspot.com",
      messagingSenderId: "292890468669",
      appId: "1:292890468669:web:1cd0a2399d99c00d10e554",
      measurementId: "G-PYPF76P6Z2",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // DOM-Elemente
    const modal = document.getElementById("modal");
    const addBtn = document.getElementById("addBtn");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const saveBtn = document.getElementById("saveBtn");
    const productList = document.getElementById("product-list");
    const sortSelect = document.getElementById("sortSelect");
    const colorPicker = document.getElementById("colorPicker");
    const syncStatus = document.getElementById("syncStatus");

    // Farbe aus LocalStorage laden oder Default
    const savedColor = localStorage.getItem("accentColor") || "#d4af37";
    document.documentElement.style.setProperty("--gold", savedColor);
    colorPicker.value = savedColor;

    // State
    let products = {};
    let isSyncing = false;

    // Modal öffnen/schließen
    addBtn.addEventListener("click", () => {
      openModal();
    });
    closeModalBtn.addEventListener("click", () => {
      closeModal();
    });
    window.addEventListener("click", (e) => {
      if (e.target === modal) closeModal();
    });

    // Modal-Funktionen
    function openModal() {
      modal.style.display = "flex";
      resetModalInputs();
    }
    function closeModal() {
      modal.style.display = "none";
      resetModalInputs();
    }
    function resetModalInputs() {
      ["imgUrl", "name", "price", "priority", "note", "link"].forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.tagName === "SELECT") el.value = "medium";
        else el.value = "";
      });
      document.getElementById("priority").value = "medium";
    }

    // Farbpicker
    colorPicker.addEventListener("input", (e) => {
      const val = e.target.value;
      document.documentElement.style.setProperty("--gold", val);
      localStorage.setItem("accentColor", val);
    });

    // Speichern Button
    saveBtn.addEventListener("click", () => {
      const imgUrl = document.getElementById("imgUrl").value.trim();
      const name = document.getElementById("name").value.trim();
      const price = document.getElementById("price").value.trim();
      const priority = document.getElementById("priority").value;
      const note = document.getElementById("note").value.trim();
      const link = document.getElementById("link").value.trim();

      if (!imgUrl || !name || !link) {
        alert("Bitte fülle die Pflichtfelder (Bild, Name, Link) aus.");
        return;
      }

      const product = {
        imgUrl,
        name,
        price,
        priority,
        note,
        link,
        added: Date.now(),
      };

      syncStatus.classList.add("visible");
      db.ref("wishlist")
        .push(product)
        .then(() => {
          syncStatus.classList.remove("visible");
        })
        .catch(() => {
          syncStatus.classList.remove("visible");
          alert("Fehler beim Speichern");
        });

      closeModal();
    });

    // Sortieren & Rendern
    sortSelect.addEventListener("change", () => {
      renderProducts();
    });

    function sortProducts(data) {
      const arr = Object.entries(data || {}).map(([key, value]) => ({
        key,
        ...value,
      }));

      switch (sortSelect.value) {
        case "addedDesc":
          arr.sort((a, b) => b.added - a.added);
          break;
        case "addedAsc":
          arr.sort((a, b) => a.added - b.added);
          break;
        case "nameAsc":
          arr.sort((a, b) => a.name.localeCompare(b.name));
          break;
        case "nameDesc":
          arr.sort((a, b) => b.name.localeCompare(a.name));
          break;
        case "priceAsc":
          arr.sort((a, b) => {
            const pA = parseFloat(a.price.replace(/[^\d.]/g, "")) || 0;
            const pB = parseFloat(b.price.replace(/[^\d.]/g, "")) || 0;
            return pA - pB;
          });
          break;
        case "priceDesc":
          arr.sort((a, b) => {
            const pA = parseFloat(a.price.replace(/[^\d.]/g, "")) || 0;
            const pB = parseFloat(b.price.replace(/[^\d.]/g, "")) || 0;
            return pB - pA;
          });
          break;
        case "priorityAsc":
          arr.sort((a, b) => priorityValue(a.priority) - priorityValue(b.priority));
          break;
        case "priorityDesc":
          arr.sort((a, b) => priorityValue(b.priority) - priorityValue(a.priority));
          break;
      }

      return arr;
    }
    function priorityValue(p) {
      if (p === "high") return 3;
      if (p === "medium") return 2;
      if (p === "low") return 1;
      return 0;
    }

    // Sync mit Firebase & Rendern
    db.ref("wishlist").on(
      "value",
      (snapshot) => {
        products = snapshot.val() || {};
        renderProducts();
      },
      (error) => {
        alert("Fehler beim Laden der Daten");
      }
    );

    // Produkt löschen mit Undo
    function deleteProduct(key, card) {
      if (
        confirm(
          "Möchtest du dieses Produkt wirklich löschen?\n\nDrücke 'OK' zum Löschen oder 'Abbrechen' um abzubrechen."
        )
      ) {
        syncStatus.classList.add("visible");
        db.ref("wishlist/" + key)
          .remove()
          .then(() => {
            syncStatus.classList.remove("visible");
          })
          .catch(() => {
            syncStatus.classList.remove("visible");
            alert("Fehler beim Löschen");
          });
      } else {
        // Undo: Swipe zurücksetzen
        card.classList.remove("show-delete");
        card.style.transform = "";
      }
    }

    // Produktkarte rendern
    function renderProducts() {
      productList.innerHTML = "";
      const sorted = sortProducts(products);
      if (sorted.length === 0) {
        productList.innerHTML = `<p style="text-align:center; color:#666;">Keine Produkte in der Wunschliste.</p>`;
        return;
      }

      sorted.forEach(({ key, imgUrl, name, price, priority, note, link }) => {
        const card = document.createElement("div");
        card.className = "card";
        card.setAttribute("tabindex", "0");
        card.setAttribute("role", "listitem");
        card.style.transform = "";
        card.innerHTML = `
          <div class="delete-swipe" aria-label="Löschen" role="button" tabindex="0"><i class="fas fa-trash"></i></div>
          <img src="${imgUrl}" alt="Produktbild von ${name}" loading="lazy" />
          <div class="card-content">
            <h3>${escapeHtml(name)}</h3>
            <p class="price">${escapeHtml(price)}</p>
            <p class="priority ${priority}">Priorität: ${priority.charAt(0).toUpperCase() + priority.slice(1)}</p>
            ${
              note
                ? `<p class="note" title="Notiz">${escapeHtml(note)}</p>`
                : ""
            }
            <a href="${escapeHtml(link)}" target="_blank" rel="noopener" style="color: var(--gold); text-decoration: underline;">Zum Shop</a>
          </div>
        `;
        productList.appendChild(card);

        // Swipe to delete setup
        setupSwipeDelete(card, key);
        setupPressHighlight(card);
      });
    }

    // Escape HTML zum Schutz
    function escapeHtml(text) {
      if (!text) return "";
      return text.replace(/[&<>"']/g, (m) => {
        return {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
        }[m];
      });
    }

    // Swipe-to-delete Funktion
    function setupSwipeDelete(card, key) {
      let startX = 0;
      let currentX = 0;
      let touching = false;
      let threshold = 80;
      let maxTranslate = -90;
      const deleteBtn = card.querySelector(".delete-swipe");

      deleteBtn.addEventListener("click", () => {
        deleteProduct(key, card);
      });
      deleteBtn.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          deleteProduct(key, card);
        }
      });

      card.addEventListener(
        "touchstart",
        (e) => {
          if (e.touches.length === 1) {
            touching = true;
            startX = e.touches[0].clientX;
            card.style.transition = "";
          }
        },
        { passive: true }
      );

      card.addEventListener(
        "touchmove",
        (e) => {
          if (!touching) return;
          currentX = e.touches[0].clientX;
          let diffX = currentX - startX;
          if (diffX < 0 && diffX >= maxTranslate) {
            card.style.transform = `translateX(${diffX}px)`;
          } else if (diffX < maxTranslate) {
            card.style.transform = `translateX(${maxTranslate}px)`;
          }
        },
        { passive: true }
      );

      card.addEventListener("touchend", () => {
        touching = false;
        const movedX = currentX - startX;
        if (movedX <= -threshold) {
          card.classList.add("show-delete");
          card.style.transform = `translateX(${maxTranslate}px)`;
        } else {
          card.classList.remove("show-delete");
          card.style.transition = "transform 0.3s ease";
          card.style.transform = "translateX(0)";
          setTimeout(() => {
            card.style.transition = "";
          }, 300);
        }
      });
    }

    // Press & Hold Highlight Animation
    function setupPressHighlight(card) {
      let pressTimer = null;
      card.addEventListener("touchstart", () => {
        pressTimer = setTimeout(() => {
          card.classList.add("pressed");
        }, 150);
      });
      card.addEventListener("touchend", () => {
        clearTimeout(pressTimer);
        card.classList.remove("pressed");
      });
      card.addEventListener("touchcancel", () => {
        clearTimeout(pressTimer);
        card.classList.remove("pressed");
      });
      // Für Maus/Klick auch:
      card.addEventListener("mousedown", () => {
        card.classList.add("pressed");
      });
      card.addEventListener("mouseup", () => {
        card.classList.remove("pressed");
      });
      card.addEventListener("mouseleave", () => {
        card.classList.remove("pressed");
      });
    }
  </script>
</body>
</html>
